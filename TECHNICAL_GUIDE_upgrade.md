# Enterprise SaaS Implementation Guide

**Version:** 1.0.0  
**Companion to:** `TECHNICAL_GUIDE.md`  
**Purpose:** Detailed technical specifications for implementing the Enterprise SaaS Upgrade features.

---

## 1. Supabase SQL Migrations & Security

### 1.1 Core Multi-Tenancy Schema
The following schema enforces the SaaS structure where **1 Organization** has **N Stores** and **N Users**.

```sql
-- Organizations (Tenants)
CREATE TABLE omtbl_organizations (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name TEXT NOT NULL,
    subscription_tier TEXT DEFAULT 'free', -- free, pro, enterprise
    subscription_status TEXT DEFAULT 'active',
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Users (Extended Profile)
-- Linked 1:1 with auth.users, but contains SaaS metadata
CREATE TABLE omtbl_users (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    auth_id UUID REFERENCES auth.users(id) NOT NULL,
    organization_id BIGINT REFERENCES omtbl_organizations(id),
    role TEXT CHECK (role IN ('owner', 'admin', 'manager', 'staff', 'driver')),
    full_name TEXT,
    email TEXT,
    is_active BOOLEAN DEFAULT TRUE,
    UNIQUE(auth_id)
);

-- RLS Helper Function
-- fast lookups of the current user's organization
CREATE OR REPLACE FUNCTION get_my_org_id()
RETURNS BIGINT AS $$
  SELECT organization_id FROM omtbl_users WHERE auth_id = auth.uid() LIMIT 1;
$$ LANGUAGE sql SECURITY DEFINER;
```

### 1.2 Row Level Security (RLS) Policies
All operational tables (Orders, Products, Customers) must have these policies enabled.

**Read Policy (Select):**
```sql
CREATE POLICY "Tenant Isolation Select" ON omtbl_orders
FOR SELECT USING (
  organization_id = get_my_org_id()
);
```

**Write Policy (Insert/Update):**
```sql
CREATE POLICY "Tenant Isolation Modify" ON omtbl_orders
FOR ALL USING (
  organization_id = get_my_org_id()
);
```

---

## 2. Edge Functions (Serverless Logic)

These functions run on Deno and handle privileged actions that the mobile client cannot perform directly securely.

### 2.1 `invite-employee`
*   **Triggers**: HTTPS Request (POST)
*   **Permission**: Requester must be `owner` or `admin`.
*   **Logic**:
    1.  Verify JWT of requester.
    2.  Check requester's role in `omtbl_users`.
    3.  Call `supabase.auth.admin.inviteUserByEmail(email)`.
    4.  Insert into `omtbl_users` with requester's `organization_id` and specified `role`.
    5.  Return success.

### 2.2 `manage-subscription` (Stripe Webhook)
*   **Triggers**: HTTPS (Stripe Webhook)
*   **Logic**:
    1.  Receive `invoice.payment_succeeded` or `customer.subscription.updated`.
    2.  Match `stripe_customer_id` to `omtbl_organizations`.
    3.  Update `subscription_status` and `subscription_expiration`.

---

## 3. Flutter Implementation Guide

### 3.1 Authentication Flow (Riverpod)
The `AuthProvider` orchestrates the session state.

1.  **App Start**:
    *   `Supabase.instance.client.auth.currentSession` check.
    *   If valid, fetch `UserProfile` (Organization & Role).
2.  **Login Screen**:
    *   `signInWithPassword()`.
    *   On Success -> Fetch Profile.
    *   If `profile.organization_id` is null -> **Onboarding Flow** (Create Org).
    *   Else -> **Dashboard**.

### 3.2 Role-Based Routing (GoRouter)
Protect routes using the `redirect` callback combined with `UserProvider` state.

```dart
GoRoute(
  path: '/settings',
  builder: (context, state) => SettingsScreen(),
  redirect: (context, state) {
    final user = ref.read(userProvider);
    // Block non-admins
    if (user.role != 'admin' && user.role != 'owner') {
      return '/dashboard'; 
    }
    return null;
  },
),
```

### 3.3 Offline Sync Service
**Service**: `SyncService` (Singleton/Provider)

**Push (Upload):**
*   Listen to `connectivity_plus`. When Online:
*   Query `local_sync_queue` (table: `id`, `table_name`, `payload`, `action`, `timestamp`).
*   Loop:
    *   Execute Supabase operation (Insert/Update).
    *   **Success**: Delete queue item.
    *   **Failure (Conflict)**: Move to `sync_conflicts` table for manual resolution.

**Pull (Download):**
*   Call `getChanges(lastSyncTimestamp)`.
*   Supabase Query: `SELECT * FROM table WHERE updated_at > lastSyncTimestamp`.
*   Upsert into local SQLite.
*   Update `lastSyncTimestamp`.

---

## 4. Admin Web Panel Spec (SaaS)

For Owners/Admins to manage the organization from a desktop.

*   **Tech Stack**: Next.js (React) + Tailwind + Supabase Auth helpers.
*   **Rationale**: Better SEO and faster text-rendering for dashboards compared to Flutter Web.
*   **Key Modules**:
    1.  **Dashboard**: Charts (Recharts) showing Revenue, Orders (Aggregated).
    2.  **Team Management**: Table to List/Invite/Revoke users (Calls Edge Functions).
    3.  **Billing Portal**: Stripe Customer Portal integration.

---

## 5. Billing & Subscription Design

**Provider**: Stripe

### 5.1 Plan Structure
*   **Basic**: $29/mo (1 User, 500 Orders)
*   **Pro**: $79/mo (5 Users, Unlimited Orders)
*   **Enterprise**: Custom

### 5.2 Database Integration
Add to `omtbl_organizations`:
*   `stripe_customer_id`: link to Stripe.
*   `stripe_subscription_id`: link to active sub.

### 5.3 Mobile Locking
If `subscription_status != 'active'`:
*   Flutter `Guard` blocks access to Create Order screens.
*   Show "Subscription Expired" banner with link to Web Portal.

